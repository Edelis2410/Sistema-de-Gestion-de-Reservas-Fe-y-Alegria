generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Rol {
  id       Int       @id @default(autoincrement())
  nombre   String    @unique @db.VarChar(50)
  usuarios Usuario[]

  @@map("roles")
}

model Usuario {
  id            Int    @id @default(autoincrement())
  nombre        String @db.VarChar(100)
  email         String @unique @db.VarChar(100)
  password_hash String @db.Text

  telefono String? @db.VarChar(20)
  foto     String? @db.Text

  activo              Boolean  @default(true)
  fecha_creacion      DateTime @default(now()) @map("fecha_creacion")
  fecha_actualizacion DateTime @updatedAt @map("fecha_actualizacion")

  notificacionesEmail Boolean @default(true)
  notificacionesPush  Boolean @default(true)
  recordatorioReserva Boolean @default(true)
  confirmacionReserva Boolean @default(true)
  notificarCambios    Boolean @default(true)
  notificarRechazos   Boolean @default(true)

  rol_id Int
  rol    Rol @relation(fields: [rol_id], references: [id])

  reservas             Reserva[]      @relation("UsuarioReservas")
  reservas_confirmadas Reserva[]      @relation("ReservaConfirmadaPor")
  notificaciones       Notificacion[]

  @@map("usuarios")
}

model Espacio {
  id             Int       @id @default(autoincrement())
  nombre         String    @unique @db.VarChar(100)
  tipo           String?   @db.VarChar(50)
  capacidad      Int
  descripcion    String?   @db.Text
  activo         Boolean   @default(true)
  // Usamos DateTime con @db.Time para que coincida con tu SQL
  horario_inicio DateTime? @default(dbgenerated("'07:00:00'")) @db.Time
  horario_fin    DateTime? @default(dbgenerated("'16:00:00'")) @db.Time
  fecha_creacion DateTime  @default(now()) @map("fecha_creacion")

  reservas Reserva[]

  @@map("espacios")
}

model Reserva {
  id                  Int       @id @default(autoincrement())
  titulo              String    @db.VarChar(200)
  fecha               DateTime  @db.Date
  // IMPORTANTE: Cambio a DateTime @db.Time para evitar error 500 al insertar
  hora_inicio         DateTime  @db.Time
  hora_fin            DateTime  @db.Time
  estado              String    @default("pendiente") @db.VarChar(20)
  creado_por_admin    Boolean   @default(false)
  motivo_rechazo      String?
  fecha_cancelacion   DateTime? @db.Timestamp
  fecha_creacion      DateTime  @default(now()) @map("fecha_creacion")
  fecha_actualizacion DateTime  @updatedAt @map("fecha_actualizacion")

  usuario_id Int
  usuario    Usuario @relation("UsuarioReservas", fields: [usuario_id], references: [id])

  espacio_id Int
  espacio    Espacio @relation(fields: [espacio_id], references: [id])

  confirmado_por    Int?
  admin_confirmador Usuario? @relation("ReservaConfirmadaPor", fields: [confirmado_por], references: [id])

  @@map("reservas")
}

model Notificacion {
  id            Int       @id @default(autoincrement())
  usuario_id    Int
  tipo          String    @db.VarChar(50)
  titulo        String    @db.VarChar(200)
  mensaje       String    @db.Text
  leido         Boolean   @default(false)
  fecha_envio   DateTime  @default(now()) @map("fecha_envio")
  fecha_lectura DateTime? @db.Timestamp

  usuario Usuario @relation(fields: [usuario_id], references: [id])

  @@map("notificaciones")
}

model Auditoria {
  id             Int      @id @default(autoincrement())
  usuario_id     Int?
  tabla_afectada String?  @db.VarChar(50)
  accion         String?  @db.VarChar(50)
  descripcion    String?  @db.Text
  fecha          DateTime @default(now()) @db.Timestamp

  @@map("auditoria")
}

model Configuracion {
  id                  Int      @id @default(autoincrement())
  clave               String   @unique @db.VarChar(100)
  valor               String   @db.Text
  descripcion         String?  @db.Text
  fecha_actualizacion DateTime @default(now()) @map("fecha_actualizacion") @db.Timestamp

  @@map("configuraciones")
}
